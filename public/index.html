<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propelity Dashboard</title>
    <link href="/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex min-h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white shadow-md">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">Propelity</h2>
            </div>
            <nav class="mt-6">
                <ul>
                    <li class="mb-1 mx-3">
                        <a href="#" class="nav-link flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors border-l-4 border-blue-600 bg-blue-50 text-blue-600" data-section="enquiries">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Enquiries
                        </a>
                    </li>
                    <li class="mb-1 mx-3">
                        <a href="#" class="nav-link flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors border-l-4 border-transparent" data-section="users">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            Users
                        </a>
                    </li>
                    <li class="mb-1 mx-3">
                        <a href="#" class="nav-link flex items-center px-4 py-3 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-md transition-colors border-l-4 border-transparent" data-section="agents">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            Agents
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-grow">
            <!-- Header -->
            <header class="bg-white shadow-sm px-6 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-semibold text-gray-800">Dashboard</h1>
                    <div class="text-sm text-gray-600">Admin Panel</div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="p-6">
                <!-- Enquiries Section -->
                <div id="enquiries-section" class="content-section">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-gray-800">Enquiries</h2>
                        <div class="text-sm text-gray-500" id="enquiries-count">Loading enquiries...</div>
                    </div>
                    
                    <div class="bg-white shadow-sm rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200" id="enquiries-table">
                                <thead class="bg-gray-50" id="enquiries-table-head">
                                    <tr>
                                        <th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-left">Loading columns...</th>
                                    </tr>
                                </thead>
                                <tbody id="enquiries-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="1" class="px-6 py-4 text-center text-sm text-gray-500">
                                            <div class="flex justify-center items-center">
                                                <svg class="animate-spin h-5 w-5 mr-3 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Loading enquiries...
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Raw Response Section -->
                    <div class="mt-6 hidden" id="raw-response-section">
                        <h3 class="text-md font-semibold mb-2">Raw Supabase Response</h3>
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <pre id="raw-response" class="text-xs overflow-x-auto">No data loaded yet.</pre>
                        </div>
                    </div>
                </div>

                <!-- Users Section (Hidden by default) -->
                <div id="users-section" class="content-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-gray-800">Users</h2>
                    </div>
                    <div class="bg-white shadow-sm rounded-lg p-6">
                        <p class="text-gray-500">User data will be displayed here.</p>
                    </div>
                </div>

                <!-- Agents Section (Hidden by default) -->
                <div id="agents-section" class="content-section hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-gray-800">Agents</h2>
                    </div>
                    <div class="bg-white shadow-sm rounded-lg p-6">
                        <p class="text-gray-500">Agent data will be displayed here.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="user-details-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden">
        <div class="flex items-center justify-center h-full">
            <div class="bg-white shadow-md rounded-lg p-6 w-96">
                <button id="close-user-modal" class="text-gray-500 hover:text-gray-700 transition-colors float-right">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div id="user-details-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Function to fetch enquiries from the API
        async function fetchEnquiries() {
            try {
                console.log('Fetching enquiries from API...');
                const response = await fetch('/api/enquiries');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Received enquiries data:', data);
                
                // Check if data is null or undefined
                if (!data) {
                    console.error('No data received from API');
                    return [];
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching enquiries:', error);
                return [];
            }
        }
        // Function to fetch users from the API
        async function fetchUsers() {
            try {
                console.log('Fetching users from API...');
                const response = await fetch('/api/users');
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Received users data:', data);
                
                // Check if data is null or undefined
                if (!data) {
                    console.error('No users data received from API');
                    return [];
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching users:', error);
                const countElement = document.getElementById('users-count');
                if (countElement) {
                    countElement.textContent = `Error: ${error.message}`;
                }
                return [];
            }
        }

        // Function to fetch a specific user by ID
        async function fetchUserById(userId) {
            try {
                const response = await fetch(`/api/users/${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Error fetching user ${userId}:`, error);
                return null;
            }
        }
        // Function to display enquiries in the table
        function displayEnquiries(enquiries) {
            const tableHead = document.getElementById('enquiries-table-head');
            const tableBody = document.getElementById('enquiries-table-body');
            const countElement = document.getElementById('enquiries-count');
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Update the count display
            if (enquiries) {
                countElement.textContent = `${enquiries.length} enquiries found`;
            } else {
                countElement.textContent = 'No enquiries found';
            }
            
            if (enquiries && enquiries.length > 0) {
                // Define the display order for columns
                const displayOrder = [
                    'id', 
                    'first_name',
                    'last_name',
                    'email',
                    'phone',
                    'budget_range',
                    'service_type',
                    'additional_info',
                    'created_at',
                    'user_id',
                    'recaptcha_token'
                ];
                
                // Filter columns that exist in the data
                const availableColumns = Object.keys(enquiries[0]);
                const columns = displayOrder.filter(col => availableColumns.includes(col));
                
                // Add any columns that might be in the data but not in our predefined order
                availableColumns.forEach(col => {
                    if (!columns.includes(col)) {
                        columns.push(col);
                    }
                });
                
                // Create table headers
                const headRow = document.createElement('tr');
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.className = 'px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-left';
                    
                    // Format column names for display
                    let displayName = col.replace(/_/g, ' ');
                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                    th.textContent = displayName;
                    
                    headRow.appendChild(th);
                });
                tableHead.appendChild(headRow);
                
                // Populate rows
                enquiries.forEach(enquiry => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    columns.forEach(col => {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-left';
                        let value = enquiry[col];
                        
                        // Format created_at as date/time if present
                        if (col === 'created_at' && value) {
                            value = new Date(value).toLocaleString();
                        }
                        
                        // Format recaptcha_token to show Present/Absent
                        if (col === 'recaptcha_token') {
                            value = value ? 'Present' : 'Absent';
                        }
                        
                        // Handle null or undefined values
                        td.textContent = value !== undefined && value !== null ? String(value) : 'N/A';
                        row.appendChild(td);
                    });
                    
                    tableBody.appendChild(row);
                });
            } else {
                // Display a message if no enquiries are found
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 1;
                cell.className = 'px-6 py-4 text-center text-sm text-gray-500';
                cell.textContent = 'No enquiries found.';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
            
            // Hide the raw response section
            document.getElementById('raw-response-section').classList.add('hidden');
        }

        // Function to display users in the table
        function displayUsers(users) {
            const tableHead = document.getElementById('users-table-head');
            const tableBody = document.getElementById('users-table-body');
            const countElement = document.getElementById('users-count');
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Update the count display
            if (users) {
                countElement.textContent = `${users.length} users found`;
            } else {
                countElement.textContent = 'No users found';
            }
            
            if (users && users.length > 0) {
                // Define which columns to display and in what order
                const displayColumns = ['id', 'first_name', 'last_name', 'email', 'phone', 'created_at'];
                
                // Create table headers
                const headRow = document.createElement('tr');
                displayColumns.forEach(col => {
                    const th = document.createElement('th');
                    th.className = 'px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-left';
                    // Format column names for display
                    let displayName = col.replace(/_/g, ' ');
                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                    th.textContent = displayName;
                    headRow.appendChild(th);
                });
                // Add an actions column
                const actionsHeader = document.createElement('th');
                actionsHeader.className = 'px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right';
                actionsHeader.textContent = 'Actions';
                headRow.appendChild(actionsHeader);
                
                tableHead.appendChild(headRow);
                
                // Populate rows
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors cursor-pointer';
                    row.setAttribute('data-user-id', user.id);
                    
                    // Add click event to show user details
                    row.addEventListener('click', () => showUserDetails(user.id));
                    
                    displayColumns.forEach(col => {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-left';
                        let value = user[col];
                        
                        // Format created_at as date/time if present
                        if (col === 'created_at' && value) {
                            value = new Date(value).toLocaleString();
                        }
                        
                        td.textContent = value !== undefined && value !== null ? String(value) : 'N/A';
                        row.appendChild(td);
                    });
                    
                    // Add view details button
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-right';
                    
                    const viewButton = document.createElement('button');
                    viewButton.className = 'text-blue-600 hover:text-blue-800 font-medium';
                    viewButton.textContent = 'View Details';
                    viewButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent row click event
                        showUserDetails(user.id);
                    });
                    
                    actionsCell.appendChild(viewButton);
                    row.appendChild(actionsCell);
                    
                    tableBody.appendChild(row);
                });
            } else {
                // Display a message if no users are found
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7; // Adjust based on number of columns
                cell.className = 'px-6 py-4 text-center text-sm text-gray-500';
                cell.textContent = 'No users found.';
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        }

        // Function to show user details in a modal
        async function showUserDetails(userId) {
            const modal = document.getElementById('user-details-modal');
            const contentDiv = document.getElementById('user-details-content');
            
            // Show loading state
            contentDiv.innerHTML = `
                <div class="flex justify-center items-center">
                    <svg class="animate-spin h-5 w-5 mr-3 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading user details...
                </div>
            `;
            
            // Show the modal
            modal.classList.remove('hidden');
            
            // Fetch user details
            const user = await fetchUserById(userId);
            
            if (user) {
                // Create a formatted display of user details
                let html = '<div class="space-y-4">';
                
                // User name header
                html += `<h4 class="text-xl font-medium text-gray-900">${user.first_name} ${user.last_name}</h4>`;
                
                // User details grid
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                // Format each field
                const fields = [
                    { label: 'User ID', value: user.id },
                    { label: 'Email', value: user.email },
                    { label: 'Phone', value: user.phone || 'N/A' },
                    { label: 'Created At', value: user.created_at ? new Date(user.created_at).toLocaleString() : 'N/A' },
                    { label: 'Subscribed', value: user.issubscribed ? 'Yes' : 'No' },
                    { label: 'Admin', value: user.isAdmin ? 'Yes' : 'No' }
                ];
                
                fields.forEach(field => {
                    html += `
                        <div class="bg-gray-50 p-3 rounded">
                            <p class="text-xs font-medium text-gray-500">${field.label}</p>
                            <p class="text-sm font-medium text-gray-900">${field.value}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                contentDiv.innerHTML = html;
            } else {
                contentDiv.innerHTML = '<p class="text-gray-500">User not found.</p>';
            }
        }

        // Function to show a specific section and hide others
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show the selected section
            const selectedSection = document.getElementById(`${sectionId}-section`);
            if (selectedSection) {
                selectedSection.classList.remove('hidden');
            }
            
            // Update active state in navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-600');
                link.classList.add('border-transparent', 'text-gray-700');
            });
            
            const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
            if (activeLink) {
                activeLink.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-600');
                activeLink.classList.remove('border-transparent', 'text-gray-700');
            }
        }

        // Function to load enquiries data
        async function loadEnquiriesData() {
            const tableBody = document.getElementById('enquiries-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="1" class="px-6 py-4 text-center text-sm text-gray-500">
                        <div class="flex justify-center items-center">
                            <svg class="animate-spin h-5 w-5 mr-3 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading enquiries...
                        </div>
                    </td>
                </tr>
            `;
            
            const enquiries = await fetchEnquiries();
            displayEnquiries(enquiries);
        }
        // Function to load users data
        async function loadUsersData() {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                        <div class="flex justify-center items-center">
                            <svg class="animate-spin h-5 w-5 mr-3 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading users...
                        </div>
                    </td>
                </tr>
            `;
            
            const users = await fetchUsers();
            displayUsers(users);
        }
        // Initialize the dashboard
        function initDashboard() {
            // Set up navigation click handlers
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.getAttribute('data-section');
                    showSection(section);
                    
                    // If enquiries section is selected, load the data
                    if (section === 'enquiries') {
                        loadEnquiriesData();
                    }                    // If users section is selected, load the data
                    else if (section === 'users') {
                        loadUsersData();
                    }                    // You can add similar conditions for other sections when they're implemented
                });
            });            
            // Set up user details modal close button
            document.getElementById('close-user-modal').addEventListener('click', () => {
                document.getElementById('user-details-modal').classList.add('hidden');
            });
            
            // Close modal when clicking outside the content
            document.getElementById('user-details-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('user-details-modal')) {
                    document.getElementById('user-details-modal').classList.add('hidden');
                }
            });            
            // Show enquiries section by default and load its data
            showSection('enquiries');
            loadEnquiriesData();
        }

        // Initialize the dashboard when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>